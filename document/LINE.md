# LINE

## イベント開催通知

システムから LINE アカウントにイベントの開催通知を送信する。

- LINE メッセージタイプ：ボタンテンプレート

リクエストヘッダー
|項目|値|
|-|-|
|Content-Type|application/json|
|Authorization|Bearer {チャンネルアクセストークン}|

リクエストボディ
|項目|値|
|-|-|
|messages|配列|
|...type|buttons|
|...text|イベントを開催します。|
|...actions|配列|
|......type|postback|
|......label|参加する|
|......data|action=attend&id=<イベント ID>|

## イベント参加登録

一般ユーザーから LINE アカウント宛に送られたイベント参加登録を処理する。

### ユーザー取得

LINE ID を元にユーザーを取得する。

- ユーザーを取得不可の場合

未登録のためユーザー登録を促す LINE メッセージを返信する。処理終了。

```
ユーザー登録してください。
```

- ユーザーを取得できた場合
  続行する。

### イベント参加登録

イベントに参加登録する。

イベントの参加締切日時を取得する。

- 参加締切日時 < 現在日時の場合

  参加登録はできないことを返信する。

```
締め切り日を過ぎているため、参加できません。
```

- 参加締切日時 >= 現在日時の場合

  処理を続行する。

対象のイベントにユーザーの参加登録をする。
|項目|値|備考|
|-|-|-|
|Prticipants|新規なら以下を追加、既存なら更新||
|...User|取得したユーザー||
|...CreatedAt|現在日時||
|...Status|attend|出席|

- 正常に登録できた場合

LINE メッセージを返信する。処理終了。

```
参加登録を受け付けました。
```

- 登録に失敗した場合

LINE メッセージを返信する。処理終了。

```
参加登録に失敗しました。
```

## ユーザー登録

一般ユーザーから LINE アカウント宛に送られたユーザー登録を処理する。

### 既存ユーザー有無の確認

LINE ID を基に既存ユーザーであるかを判断する。

### ユーザー作成

Firebase ユーザーを作成する。

以下の項目を設定する。（一般ユーザーは管理画面にログインしないので、ID/パスワードは何でもよい）
|項目|値|
|-|-|
|Id|ランダム値@ak2ie.net|
|パスワード|ランダム値|

ユーザーのデータを作成する。
|項目|値|
|-|-|
|Id|ユーザー作成時に指定した値|
|名前|空白|
|LINE ID|LINE ID|
|ユーザ種別|一般|

## メッセージ送信

管理者が管理画面から一般ユーザーにメッセージを送信する。
